<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>EVE-NG VM GCP Control Script</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
      background-color: #f8f8f8;
      color: #333;
    }
    h1, h2 {
      color: #005792;
    }
    pre {
      background-color: #272822;
      color: #f8f8f2;
      padding: 15px;
      overflow-x: auto;
      white-space: pre-wrap;
      border-radius: 5px;
    }
    ul {
      line-height: 1.7;
    }
    details {
      margin-top: 20px;
      margin-bottom: 30px;
    }
    summary {
      font-weight: bold;
      cursor: pointer;
      color: #007ACC;
    }
    .code-title {
      margin-bottom: 10px;
      font-weight: bold;
    }
    footer {
      margin-top: 40px;
      font-size: 0.9em;
      color: #888;
    }
  </style>
</head>
<body>

  <h1>üìò EVE-NG VM GCP Control Script</h1>

  <p>This Python script is designed to manage an <strong>EVE-NG virtual machine hosted on Google Cloud Platform (GCP)</strong>. It automates VM operations, SSH access, and lab node control.</p>

  <h2>‚úÖ Key Features</h2>
  <ul>
    <li>Starts and stops the VM using <code>gcloud</code> CLI</li>
    <li>Optionally creates a snapshot image after stopping the VM</li>
    <li>Assigns IAM roles to a user with confirmation</li>
    <li>Waits until the VM is in RUNNING state before proceeding</li>
    <li>Retrieves external IP of the VM and opens the EVE-NG Web UI</li>
    <li>Uses <code>plink</code> to SSH into VM and start specific node IDs</li>
    <li>Clean command-line interface with emoji feedback</li>
  </ul>

  <h2>üõ† Optional Improvements</h2>
  <ul>
    <li>Add function to <strong>stop all nodes</strong> before stopping the VM</li>
    <li>Validate paths to <code>gcloud</code> and <code>plink</code></li>
    <li>Log all activities to a file</li>
    <li>Enable CLI-only or headless operation</li>
  </ul>

  <details>
    <summary>üìÇ View Full Python Script</summary>
    <p class="code-title">Filename: <code>eveng_vm_control.py</code></p>
    <pre>


      import subprocess
import time
import webbrowser
import getpass
import logging

# ----------- CONFIGURATION ------------
PROJECT_ID = "eveng-cloud123sj"
ZONE = "us-central1-a"
VM_NAME = "basic-ise-eveng"
GCLOUD_PATH = r"C:\Users\suraj\AppData\Local\Google\Cloud SDK\google-cloud-sdk\bin\gcloud.cmd"
PLINK_PATH = r"C:\Program Files\EVE-NG\plink.exe"
LAB_PATH = "/opt/unetlab/labs/ise.unl"
TENANT_ID = "0"
NODE_IDS = ["1", "2", "3", "4", "5", "6"]
# ---------------------------------------

# ----------- LOGGING SETUP ------------
log_filename = f"eveng_log_{time.strftime('%Y%m%d-%H%M%S')}.log"
logging.basicConfig(
    filename=log_filename,
    level=logging.INFO,
    format="%(asctime)s - %(levelname)s - %(message)s"
)
console = logging.StreamHandler()
console.setLevel(logging.INFO)
formatter = logging.Formatter("%(message)s")
console.setFormatter(formatter)
logging.getLogger().addHandler(console)
# ---------------------------------------

def gcloud_command(args):
    try:
        result = subprocess.run(
            [GCLOUD_PATH] + args,
            shell=True,
            check=True,
            capture_output=True,
            text=True
        )
        return result.stdout.strip(), 0
    except subprocess.CalledProcessError as e:
        logging.error(f"gcloud error: {e.stderr.strip()}")
        return None, e.returncode

def is_vm_running():
    status = gcloud_command([
        "compute", "instances", "describe",
        VM_NAME,
        "--zone", ZONE,
        "--project", PROJECT_ID,
        "--format=get(status)"
    ])
    logging.info(f"üìå Current status of VM: {status}")
    return status == "RUNNING"

def start_vm():
    logging.info(f"üöÄ Starting VM '{VM_NAME}'...")
    output = gcloud_command([
        "compute", "instances", "start",
        VM_NAME,
        "--zone", ZONE,
        "--project", PROJECT_ID
    ])
    if output:
        logging.info("‚úÖ VM start command issued successfully.")

def stop_vm():
    logging.info(f"üõë Stopping VM '{VM_NAME}'...")
    output = gcloud_command([
        "compute", "instances", "stop",
        VM_NAME,
        "--zone", ZONE,
        "--project", PROJECT_ID
    ])
    if output:
        logging.info("‚úÖ VM stopped successfully.")

def create_vm_image(confirm=True):
    if confirm:
        choice = input(f"\nüì∏ Do you want to create a snapshot image of VM '{VM_NAME}' after shutdown? (y/n): ").strip().lower()
        if choice != 'y':
            logging.info("‚ùå Image creation skipped.")
            return

    timestamp = time.strftime("%Y%m%d-%H%M%S")
    image_name = f"{VM_NAME}-image-{timestamp}"

    logging.info(f"üì∏ Creating image '{image_name}' from stopped VM '{VM_NAME}'...")

    result = gcloud_command([
        "compute", "images", "create", image_name,
        "--source-disk", VM_NAME,
        "--source-disk-zone", ZONE,
        "--project", PROJECT_ID,
        "--labels", "type=eveng,image_created_by=script"
    ])

    if result:
        logging.info(f"‚úÖ Image '{image_name}' created successfully.")
    else:
        logging.error("‚ùå Failed to create image.")

def assign_iam_roles(confirm=True):
    if confirm:
        choice = input("üîê Do you want to assign IAM roles to a user? (y/n): ").strip().lower()
        if choice != 'y':
            logging.info("‚ùå IAM role assignment skipped.")
            return

    user_email = input("üìß Enter the user's email (e.g., user@example.com): ").strip()
    if not user_email or "@" not in user_email:
        logging.error("‚ùå Invalid email. Skipping IAM assignment.")
        return

    roles = [
        "roles/compute.imageUser",
        "roles/editor"
    ]

    for role in roles:
        logging.info(f"‚û°Ô∏è Assigning role {role} to {user_email}...")
        result = gcloud_command([
            "projects", "add-iam-policy-binding", PROJECT_ID,
            "--member", f"user:{user_email}",
            "--role", role,
            "--quiet"
        ])
        if result is not None:
            logging.info(f"‚úÖ Role '{role}' assigned.")
        else:
            logging.error(f"‚ùå Failed to assign role '{role}'.")
    logging.info("‚úÖ All selected IAM roles processed.")

def wait_until_running():
    logging.info("‚è≥ Waiting for VM to be RUNNING...")
    while True:
        status = gcloud_command([
            "compute", "instances", "describe",
            VM_NAME,
            "--zone", ZONE,
            "--project", PROJECT_ID,
            "--format=get(status)"
        ])
        logging.info(f"üìå Current status: {status}")
        if status == "RUNNING":
            logging.info("‚úÖ VM is now RUNNING.")
            break
        time.sleep(5)

def get_external_ip():
    ip = gcloud_command([
        "compute", "instances", "describe",
        VM_NAME,
        "--zone", ZONE,
        "--project", PROJECT_ID,
        "--format=get(networkInterfaces[0].accessConfigs[0].natIP)"
    ])
    if ip:
        logging.info(f"üåê External IP of EVE-NG VM: {ip}")
    return ip

def open_eveng_web(ip):
    url = f"http://{ip}"
    logging.info(f"üì£ Opening EVE-NG Web UI at: {url}")
    webbrowser.open(url)

def connect_via_plink(ip):
    logging.info(f"üîê Connecting to EVE-NG via SSH: root@{ip}")
    password = getpass.getpass("Enter password for root@{}: ".format(ip))

    node_start_commands = " && ".join([
        f"/opt/unetlab/wrappers/unl_wrapper -a start -T {TENANT_ID} -F {LAB_PATH} -D {node_id}"
        for node_id in NODE_IDS
    ])

    ssh_command = f"{node_start_commands} && echo '‚úÖ All specified nodes started.'"

    command = [
        PLINK_PATH,
        "-ssh", f"root@{ip}",
        "-pw", password,
        ssh_command
    ]

    try:
        subprocess.run(command, check=True)
    except subprocess.CalledProcessError as e:
        logging.error(f"‚ùå SSH connection or node start failed: {e}")

def is_authenticated():
    result = gcloud_command(["auth", "list", "--format=value(account)"])
    return bool(result)

def list_projects():
    result = gcloud_command(["projects", "list", "--format=value(projectId)"])
    if result:
        projects = result.splitlines()
        for i, proj in enumerate(projects, start=1):
            print(f"{i}. {proj}")
        return projects
    else:
        logging.error("‚ùå Could not retrieve project list.")
        return []

def choose_project(projects):
    while True:
        choice = input("üî¢ Select a project number from the list above: ").strip()
        if choice.isdigit() and 1 <= int(choice) <= len(projects):
            return projects[int(choice) - 1]
        else:
            print("‚ùå Invalid choice. Try again.")

def authenticate_user():
    username = input("üë§ Enter your Google Cloud username/email: ").strip()
    subprocess.run([GCLOUD_PATH, "auth", "login", "--brief"], shell=True)
    logging.info("‚úÖ Auth process initiated. Continue in browser...")

def main():
    logging.info("\nüîß Checking if user is authenticated with Google Cloud...\n")

    if not is_authenticated():
        logging.info("üîê No authenticated user found.")
        authenticate_user()
    else:
        logging.info("‚úÖ User is already authenticated.")

    logging.info("\nüìã Fetching available GCP projects...\n")
    projects = list_projects()
    if not projects:
        logging.error("‚ùå No projects found. Exiting.")
        return

    selected_project = choose_project(projects)
    output, code = gcloud_command(["config", "set", "project", selected_project])
    if code == 0:
       global PROJECT_ID
       PROJECT_ID = selected_project
       logging.info(f"‚úÖ Project set to: {PROJECT_ID}")
    else:
       logging.error("‚ùå Failed to set project. Exiting.")
    return

    logging.info("\nüîß Checking EVE-NG VM status on Google Cloud...\n")

    vm_running = is_vm_running()

    if vm_running:
        logging.info("‚úÖ VM is already RUNNING.")
        stop_choice = input("‚ùì Do you want to stop the VM? (y/n): ").strip().lower()
        if stop_choice == 'y':
            snapshot_choice = input(f"üì∏ Do you want to create a snapshot image of VM '{VM_NAME}' after shutdown? (y/n): ").strip().lower()
            iam_choice = input("üîê Do you want to assign IAM roles to a user? (y/n): ").strip().lower()

            stop_vm()

            if snapshot_choice == 'y':
                create_vm_image(confirm=False)

            if iam_choice == 'y':
                assign_iam_roles(confirm=False)

            logging.info("‚úÖ All selected actions completed. Exiting.")
            return
        else:
            logging.info("‚û°Ô∏è Continuing to use the running VM.")
    else:
        logging.info("üìå VM is currently STOPPED (TERMINATED).")
        logging.info(f"üöÄ Starting VM '{VM_NAME}'...")
        start_vm()
        wait_until_running()

    ip = get_external_ip()
    if ip:
        open_eveng_web(ip)
        connect_via_plink(ip)
    else:
        logging.error("‚ùå Could not retrieve external IP. Exiting.")

    logging.info("\n‚úÖ Script finished. Press Enter to close.")
    input()

if __name__ == "__main__":
    main()



    </pre>
  </details>

  <footer>Created by Suraj Joshi | Network Automation Utility | v1.0</footer>
</body>
</html>

